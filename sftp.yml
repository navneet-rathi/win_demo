---
- name: SFTP a file from Windows to Linux
  hosts: all
  gather_facts: no
  tasks:
    - name: Check if PSFTP exists on Windows
      ansible.windows.win_stat:
        path: "C:\\Windows\\System32\\psftp.exe"
      register: psftp_status

    - name: Debug - Show if PSFTP exists
      ansible.builtin.debug:
        msg: "PSFTP is already installed."  
      when: psftp_status.stat.exists

    - name: Download PuTTY PSFTP on Ansible Control Node
      ansible.builtin.get_url:
        url: "https://the.earth.li/~sgtatham/putty/latest/w64/psftp.exe"
        dest: "/tmp/psftp.exe"
        mode: '0755'
      delegate_to: localhost
      when: not psftp_status.stat.exists  

    - name: Copy PSFTP to Windows Host
      ansible.windows.win_copy:
        src: "/tmp/psftp.exe"
        dest: "C:\\psftp.exe"
      when: not psftp_status.stat.exists
      
    - name: Find the target file
      ansible.windows.win_find:
        paths: "C:\\Users\\nrathi\\Desktop\\nrathi\\"
        patterns: "*.log"
        recurse: true
      register: found_files

    - name: Debug - Show found files
      ansible.builtin.debug:
        msg: "{{ found_files.files | map(attribute='path') | list }}"

    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\temp"
        state: directory

    - name: Upload found files via SFTP
      ansible.builtin.win_shell: |
        echo 'open nrathi@192.168.1.13 -pw primod123' > C:\temp\sftp_commands.txt
        echo 'lcd C:\Users\nrathi\Desktop\nrathi\' >> C:\temp\sftp_commands.txt
        echo 'cd /home/nrathi/uploads' >> C:\temp\sftp_commands.txt
        {% for file in found_files.files %}
        echo 'put {{ file.path }}'' >> C:\temp\sftp_commands.txt
        {% endfor %}
        echo 'bye' >> C:\temp\sftp_commands.txt
        C:\\psftp.exe -b C:\temp\sftp_commands.txt